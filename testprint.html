<html>
<head>
    <title>Printer Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-2">
                <!-- Printers! -->
                <div class="row">
                    <div class="col-sm-12">
                        <span id="status">No printer detected.</span>
                        <button class="btn btn-primary" id="addprinter">âž• Add Printer</button>
                    </div>
                </div>
                <div id="printerlist">
                </div>
            </div>
            <div class="col-10">
                <!-- Things to print! -->
                <textarea id="data" cols="80", rows="24"></textarea>
            </div>
        </div>
    </div>
<script>

// idb keyval wrapper
// https://github.com/jakearchibald/idb-keyval
function _typeof(n){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n})(n)}!function(n,t){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((n="undefined"!=typeof globalThis?globalThis:n||self).idbKeyval={})}(this,(function(n){"use strict";function t(n){return new Promise((function(t,e){n.oncomplete=n.onsuccess=function(){return t(n.result)},n.onabort=n.onerror=function(){return e(n.error)}}))}function e(n,e){var r,o=(!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise((function(n){var t=function(){return indexedDB.databases().finally(n)};r=setInterval(t,100),t()})).finally((function(){return clearInterval(r)})):Promise.resolve()).then((function(){var r=indexedDB.open(n);return r.onupgradeneeded=function(){return r.result.createObjectStore(e)},t(r)}));return function(n,t){return o.then((function(r){return t(r.transaction(e,n).objectStore(e))}))}}var r;function o(){return r||(r=e("keyval-store","keyval")),r}function u(n,e){return n("readonly",(function(n){return n.openCursor().onsuccess=function(){this.result&&(e(this.result),this.result.continue())},t(n.transaction)}))}n.clear=function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:o();return n("readwrite",(function(n){return n.clear(),t(n.transaction)}))},n.createStore=e,n.del=function(n){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:o();return e("readwrite",(function(e){return e.delete(n),t(e.transaction)}))},n.delMany=function(n){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:o();return e("readwrite",(function(e){return n.forEach((function(n){return e.delete(n)})),t(e.transaction)}))},n.entries=function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:o(),t=[];return u(n,(function(n){return t.push([n.key,n.value])})).then((function(){return t}))},n.get=function(n){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:o();return e("readonly",(function(e){return t(e.get(n))}))},n.getMany=function(n){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:o();return e("readonly",(function(e){return Promise.all(n.map((function(n){return t(e.get(n))})))}))},n.keys=function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:o(),t=[];return u(n,(function(n){return t.push(n.key)})).then((function(){return t}))},n.promisifyRequest=t,n.set=function(n,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:o();return r("readwrite",(function(r){return r.put(e,n),t(r.transaction)}))},n.setMany=function(n){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:o();return e("readwrite",(function(e){return n.forEach((function(n){return e.put(n[1],n[0])})),t(e.transaction)}))},n.update=function(n,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:o();return r("readwrite",(function(r){return new Promise((function(o,u){r.get(n).onsuccess=function(){try{r.put(e(this.result),n),o(t(r.transaction))}catch(n){u(n)}}}))}))},n.values=function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:o(),t=[];return u(n,(function(n){return t.push(n.value)})).then((function(){return t}))},Object.defineProperty(n,"__esModule",{value:!0})}));


// Globals because I roll cool like that
var devices = [];

// Classes because I roll cool like that
class lp2844 {
    #cmdBuffer = "";
    #fontNumber = "1";

    // LP 2844 has a 203 DPI print head
    #dpi = 203;

    #xLabel;
    #yLabel;

    // Temp holders on a per-label basis.
    #xOffset = 0;
    #yOffset = 0;

    constructor(labelWidth, labelHeight, device) {
        this.labelWidth = labelWidth; // inches
        this.#xLabel = Math.trunc(labelWidth * this.#dpi);

        this.labelHeight = labelHeight; // inches
        this.#yLabel = Math.trunc(labelHeight * this.#dpi);

        this.device = device; // The USB device to work with

        // Additional spacing between lines of text, in dots.
        this.lineSpacing = 0;
    }

    // LP 2844 and variants use this USB vendor ID
    static get usbVendorId() { return 0x0a5f; }

    // LP 2844 print heads are 203 DPI.
    get dpi() { return this.#dpi; }

    get serial() { return this.device.serialNumber; }

    get commandBuffer() { return this.#cmdBuffer; }

    get labelWidthDots() { return this.#xLabel; }
    get labelHeightDots() { return this.#yLabel; }

    get fontSizes() {
        return {
            "1" :  { "y" : 12, "x" : 8 },
            "2" :  { "y" : 16, "x" : 10 },
            "3" :  { "y" : 20, "x" : 12 },
            "4" :  { "y" : 24, "x" : 14 },
            "5" :  { "y" : 48, "x" : 32 }
        };
    };

    /**
     * Begin a new label. Must be called to start a new label.
     */
    begin() {
        return this.addCmd("\nN");
    }

    /**
     * Complete a label. Must be called to print the label.
     * @param (int) count - The number of labels to print, 1 or higher.
     */
    end(count) {
        count = Math.trunc(count) || 1;
        count = (count < 1) ? 1 : count;

        return this.addCmd(`P${count}`);
    }

    /**
     * Run the commands in the command buffer against the printer, clearing the buffer.
     */
    async print() {
        // Open the device and connect to its interface (there should be 1)
        await this.device.open();

        try {
            await this.device.selectConfiguration(1);
            await this.device.claimInterface(0);

            // Select the correct single output endpoint
            let outEndpoint;
            for (let endpoint of this.device.configuration.interfaces[0].alternate.endpoints) {
                if (endpoint.direction == 'out') {
                    outEndpoint = endpoint;
                    break;
                }
            }

            if (!outEndpoint) {
                console.log("Failed to connect to printer out endpoint!");
                return;
            }

            // Dump the buffer out, ensuring to clean it in the finally.
            const buffer = (new TextEncoder()).encode(this.#cmdBuffer);
            await this.device.transferOut(outEndpoint.endpointNumber, buffer);
        } catch (e) {
            console.log(`Print error: ${e.name}: ${e.message}`);
        } finally {
            await this.device.close();
            this.clearCommandBuffer();
            this.clearOffsets();
        }
    }

    setFont(fontNumber) {
        fontNumber = Math.trunc(fontNumber) || 1;

        if (fontNumber < 1 || fontNumber > 5) {
            console.log("Invalid font size! Defaulting to 1");
            this.#fontNumber = 1;
            return;
        }

        this.#fontNumber = fontNumber;
        return this;
    }

    setOffset(x, y) {
        this.#xOffset = Math.trunc(x) || 0;

        if (y !== undefined) {
            this.#yOffset = Math.trunc(y) || 0;
        }
        return this;
    }

    /**
     * Send the configured label width to the printer
     */
    async setLabelWidth() {
        this.begin();
        this.addCmd("q" + this.#xLabel);
        await this.print();
    }

    /**
     * Perform an autocalibration for the label length
     */
    async setLabelHeightCalibration() {
        this.begin();
        this.addCmd("xa");
        await this.print();
    }

    /**
     * Add text, advancing the yOffset by the font height + line spacing.
     *
     * @param (string) text - The text to add
     * @param (int) size - The size to scale the font, 1-6
     *
     * @example
     *     addText("Hello world!", 1)
     */
    addText(text, size) {
        text = text || "";
        size = Math.trunc(size) || 1;

        this.#addTextRaw(xOffset, this.#yOffset, 0, this.#fontNumber, size, size, false, text);

        let textHeight = (size * this.fontSizes()[this.#fontNumber]["y"]);
        this.#yOffset += Math.trunc(textHeight + this.lineSpacing);

        return this;
    }

    /**
     * Add text centered on the label, advancing the yOffset by the font height + line spacing.
     *
     * @param (string) text - The text to add
     * @param (int) size - The size to scale the font, 1-6
     *
     * @example
     *     addTextCentered("Hello world!", 1)
     */
    addTextCentered(text, size) {
        text = text || "";
        size = Math.trunc(size) || 1;

        // Width = string length * character width * char size stretch
        let textWidth = (text.length * size * this.fontSizes()[this.#fontNumber]["x"]);
        let xOffset = Math.trunc((this.#xLabel - textWidth) / 2);

        this.#addTextRaw(xOffset, this.#yOffset, 0, this.#fontNumber, size, size, false, text);

        let textHeight = (size * this.fontSizes()[this.#fontNumber]["y"]);
        this.#yOffset += Math.trunc(textHeight + this.lineSpacing);

        return this;
    }

    /**
     * Draw a line, starting at the current offset and going for length and height.
     *
     * @param (int) length - The horizontal length of the line
     * @param (int) height - The vertical height of the line
     * @param (string) drawmode - The mode to draw with, either 'black' (default), 'white', or 'xor'.
     */
    addLine(length, height, drawmode) {
        length = Math.trunc(length) || 0;
        height = Math.trunc(height) || 0;

        switch (drawmode) {
            default:
            case "black":
                drawmode = "LO";
                break;
            case "white":
                drawmode = "LW";
                break;
            case "xor":
                drawmode = "LE";
                break;
        }

        this.addCmd(drawmode + this.#xOffset, this.#yOffset, length, height);

        return this;
    }

    addBox(length, height, thickness) {
        length = Math.trunc(length) || 0;
        height = Math.trunc(height) || 0;
        thickness = Math.trunc(thickness) || 0;

        this.addCmd("X" + this.#xOffset, this.#yOffset, thickness, length, height);
        return this;
    }

    /**
     * Add command, concatenating given parameters with a comma.
     *
     * @param (array) parameters - The command and parameters to add, first element should be the command and the first parameter.
     *
     * @example
     * addCmd("A10", 10, 0, 1, 1, 1, "N", "Hello World!");
     */
    addCmd(...parameters){
        this.#cmdBuffer += parameters.join(',') + "\n";
        return this;
    }

    clearCommandBuffer() {
        this.#cmdBuffer = "";
        return this;
    }

    clearOffsets() {
        this.#xOffset = 0;
        this.#yOffset = 0;
        return this;
    }

    #addTextRaw(xOffset, yOffset, rotation, font, xMultiplier, yMultiplier, reverse, data) {
        data = this.#cleanString((data || ""));
        reverseImage = (reverse) ? "R" : "N";

        if (!Number.isInteger(rotation) || rotation < 0 || rotation > 3) {
            rotation = 0;
        }

        xMultiplier = ((xMultiplier >= 1 && xMultiplier <= 6) || xMultiplier === 8) ? xMultiplier : 1;
        yMultiplier = ((yMultiplier >= 1 && yMultiplier <= 9)) ? yMultiplier : 1;

        this.addCmd("A" + xOffset, yOffset, rotation, font, xMultiplier, yMultiplier, reverseImage, "\"" + data + "\"");
    }

    #cleanString(str) {
        return str.replace(/\\/gi,"\\\\")
        .replace(/"/gi,"\\\"")
        .replace(/[\r\n]+/gi," ");
    }
}

let status = document.getElementById('status');

function addPrinterButtons() {
    let container = document.getElementById("printerlist");
    container.innerHTML = "";
    devices.forEach((device, index) => {
        let epl = new lp2844(2.25, 1.25, device);
        let element = document.createElement("div");
        element.style.borderWidth = "1px";
        element.style.borderColor = "black";
        element.innerHTML = `
<div id="printer_${index}" class="row" style="border: 1px solid black;">
    <div class="col-sm-9">
        <div class="col-sm-12">
            <span data-serial="${epl.serial}">${epl.serial}</span>
        </div>
        <div class="col-sm-12">
            <span>${epl.labelWidth} x ${epl.labelHeight}</span>
        </div>
    </div>
    <div class="col-sm-3">
        <div class="btn-group" role="group" aria-label="Printer button group">
            <button id="printto_${index}" class="btn btn-success btn-sm" data-label-width="${epl.labelWidth}" data-label-height="${epl.labelHeight}" data-device-id="${index}">ðŸ–¨</button>
                <button class="btn btn-primary dropdown-toggle"  data-bs-toggle="dropdown" aria-expanded="false">
                    <span class="visually-hidden">Settings</span>
                </button>
                <ul class="dropdown-menu">
                    <li><a id="printtest_${index}" data-device-id="${index}" class="dropdown-item" href="#">
                        Print test page
                    </a></li>
                    <li><a id="autosense_${index}" data-device-id="${index}" class="dropdown-item" href="#">
                        AutoSense length
                    </a></li>
                    <li><a id="setlabel_${index}" data-device-id="${index}" class="dropdown-item" href="#">
                        Set label config
                    </a></li>
                </ul>
            </div>
        </div>
    </div>
</div>`;
        container.appendChild(element);
        document.getElementById(`printto_${index}`).addEventListener('click', async (e) => {
            let device = devices[e.target.dataset.deviceId];
            let epl = new lp2844(
                e.target.dataset.labelWidth,
                e.target.dataset.labelHeight,
                device,
            );
            await epl.begin().end().print();
        });
        document.getElementById(`autosense_${index}`).addEventListener('click', async (e) => {
            let device = devices[e.target.dataset.deviceId];
            let epl = new lp2844(
                4,
                4,
                device,
            );
            await epl.setLabelWidth();
            await epl.setLabelHeightCalibration();
        });
        document.getElementById(`printtest_${index}`).addEventListener('click', async (e) => {
            let device = devices[e.target.dataset.deviceId];
            let epl = new lp2844(
                4,
                4,
                device,
            );
            let quarter = (epl.labelWidthDots) / 4;
            let lineHeight = 20;

            // Draw a test pattern that looks like
            // â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
            // â–ˆâ–ˆâ–ˆ
            //    â–ˆâ–ˆâ–ˆ
            //       â–ˆâ–ˆâ–ˆ
            //          â–ˆâ–ˆâ–ˆ
            // ////////////
            await epl.setLabelWidth();
            epl.begin()
                .setOffset(0, lineHeight)
                .addLine(epl.labelWidthDots, 20)
                .setOffset(0, lineHeight * 2)
                .addLine(quarter, 20)
                .setOffset(quarter, lineHeight * 3)
                .addLine(quarter, 20)
                .setOffset(quarter * 2, lineHeight * 4)
                .addLine(quarter, 20)
                .setOffset(quarter * 3, lineHeight * 5)
                .addLine(quarter, 20)
                .setOffset(0, lineHeight * 6);

            let slashStart = lineHeight * 6;
            let slashHeight = 12;
            for (let i = 0; i <= epl.labelWidthDots; i += 4) {
                epl.setOffset(i + 0, slashStart + 0)
                    .addLine(1, slashHeight)
                    .setOffset(i + 1, slashStart + slashHeight)
                    .addLine(1, slashHeight)
                    .setOffset(i + 2, slashStart + (slashHeight * 2))
                    .addLine(1, slashHeight)
                    .setOffset(i + 3, slashStart + (slashHeight * 3))
                    .addLine(1, slashHeight)
            }
            epl.end();
            await epl.print();
        });
    });
}

navigator.usb.getDevices().then((printers) => {
    devices = printers;
    addPrinterButtons();
});

navigator.usb.addEventListener('connect', (e) => {
    if (!devices.includes(e.device)) {
        devices.push(e.device);
    }

    addPrinterButtons();
});

navigator.usb.addEventListener('disconnect', (e) => {
    const idx = devices.findIndex(i => e.device == i);
    if (idx > -1) {
        devices.splice(idx, 1);
    }
    addPrinterButtons();
});

document.getElementById('addprinter').addEventListener('click', async () => {
    let device;
    try {
        device = await navigator.usb.requestDevice({ filters: [
            { vendorId: lp2844.usbVendorId }
        ]});
    } catch (e) {
        console.log("Failed to connect to printer!");
        return;
    }

    if (!devices.includes(device)) {
        devices.push(device);
    }

    addPrinterButtons();
});

</script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js" integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
</body>
</html>